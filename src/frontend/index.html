<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Statistical Anomaly Detector</title>
    <style>
        body { font-family: sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; background-color: #f4f4f9; }
        .container { background: white; padding: 25px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        h1 { color: #333; }
        .disclaimer { font-size: 0.9em; color: #666; background: #eee; padding: 10px; border-radius: 4px; margin-bottom: 20px; }
        .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        label { display: block; margin-bottom: 5px; font-weight: bold; font-size: 0.9em; }
        input, select { width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box; }
        .full-width { grid-column: span 2; }
        button { background-color: #007bff; color: white; padding: 12px 20px; border: none; border-radius: 4px; cursor: pointer; font-size: 1em; width: 100%; margin-top: 15px; }
        button:hover { background-color: #0056b3; }
        button:disabled { background-color: #ccc; }
        .result-card { margin-top: 25px; border-top: 2px solid #eee; padding-top: 20px; display: none; }
        .badge { padding: 5px 10px; border-radius: 4px; font-weight: bold; color: white; display: inline-block; }
        .badge.Normal { background-color: #28a745; }
        .badge.Suspicious { background-color: #ffc107; color: #333; }
        .badge.Anomaly { background-color: #dc3545; }
        .feedback-section { margin-top: 15px; background: #f9f9f9; padding: 10px; border-radius: 4px; text-align: center; }
        .feedback-btn { width: auto; margin: 0 5px; padding: 8px 15px; font-size: 0.9em; }
        .feedback-btn.correct { background-color: #28a745; }
        .feedback-btn.incorrect { background-color: #dc3545; }
    </style>
</head>
<body>

<div class="container">
    <h1>Statistical Anomaly Detector</h1>
    <div class="disclaimer">
        This is a statistical anomaly detector — not a definitive attack verdict.
    </div>

    <form id="predictForm">
        <div class="form-grid">
            <!-- 3 Categorical -->
            <div>
                <label>Protocol Type</label>
                <select id="protocol_type">
                    <option value="tcp">tcp</option>
                    <option value="udp">udp</option>
                    <option value="icmp">icmp</option>
                </select>
            </div>
            <div>
                <label>Service (Top 20 handled)</label>
                <input type="text" id="service" placeholder="e.g. http, private, smtp" value="http">
            </div>
            <div>
                <label>Flag</label>
                <select id="flag">
                    <option value="SF">SF (Normal)</option>
                    <option value="S0">S0</option>
                    <option value="REJ">REJ</option>
                    <option value="RSTR">RSTR</option>
                    <option value="SH">SH</option>
                    <option value="RSTO">RSTO</option>
                    <option value="S1">S1</option>
                    <option value="S2">S2</option>
                    <option value="S3">S3</option>
                    <option value="OTH">OTH</option>
                </select>
            </div>

            <!-- Numeric -->
            <div><label>Duration</label><input type="number" id="duration" value="0" min="0"></div>
            <div><label>Src Bytes</label><input type="number" id="src_bytes" value="200" min="0"></div>
            <div><label>Dst Bytes</label><input type="number" id="dst_bytes" value="400" min="0"></div>
            <div><label>Count (same host)</label><input type="number" id="count" value="1" min="0"></div>
            <div><label>Srv Count</label><input type="number" id="srv_count" value="1" min="0"></div>
            <div><label>Serror Rate (0-1)</label><input type="number" id="serror_rate" value="0.0" step="0.01" min="0" max="1"></div>
            <div><label>Dst Host Count</label><input type="number" id="dst_host_count" value="5" min="0"></div>
            
            <!-- Extra typical fields -->
            <div><label>Same Srv Rate (0-1)</label><input type="number" id="same_srv_rate" value="1.0" step="0.01" min="0" max="1"></div>
            <div><label>Diff Srv Rate (0-1)</label><input type="number" id="diff_srv_rate" value="0.0" step="0.01" min="0" max="1"></div>
        </div>

        <button type="submit" id="submitBtn">Predict Status</button>
        <button type="button" id="resetBtn" style="background-color: #6c757d; margin-top: 10px;">Reset Form</button>
    </form>

    <div id="resultCard" class="result-card">
        <h3>Result: <span id="resBadge" class="badge"></span></h3>
        <p><strong>Score:</strong> <span id="resScore"></span> (Percentile: <span id="resPercentile"></span>%)</p>
        <p><strong>Analysis:</strong> <span id="resNotes"></span></p>
        
        <div style="background:#eee; padding:10px; margin-top:10px; border-radius:4px;">
            <strong>Top Contributing Features:</strong>
            <ul id="resFeatures" style="margin:5px 0 0 20px; padding:0;"></ul>
        </div>

        <div class="feedback-section" id="feedbackSection">
            <p>Was this result useful?</p>
            <button class="feedback-btn correct" onclick="sendFeedback('correct')">✔ Mark Correct</button>
            <button class="feedback-btn incorrect" onclick="sendFeedback('incorrect')">✘ Mark Incorrect</button>
        </div>
    </div>
</div>

<script>
    const API_URL = ""; // Relative path if served from same origin

    let currentRequestId = null;
    let currentInputData = null;

    document.getElementById('resetBtn').addEventListener('click', () => {
        document.getElementById('predictForm').reset();
        document.getElementById('resultCard').style.display = 'none';
        document.getElementById('submitBtn').disabled = false;
    });

    document.getElementById('predictForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const btn = document.getElementById('submitBtn');
        btn.disabled = true;
        btn.innerText = "Analyzing...";

        // Collect Data
        const fields = [
            "protocol_type", "service", "flag", 
            "duration", "src_bytes", "dst_bytes", 
            "count", "srv_count", "serror_rate", "dst_host_count",
            "same_srv_rate", "diff_srv_rate"
        ];
        
        const payload = {};
        fields.forEach(f => {
            let val = document.getElementById(f).value;
            // Basic type conversion
            if (document.getElementById(f).type === 'number') {
                payload[f] = parseFloat(val);
            } else {
                payload[f] = val;
            }
        });

        // Add dummy values for other fields expected by validation/model if needed
        // (Recovered list had many more, model utils fills missing with 0/default or handles them)
        
        currentInputData = payload;

        try {
            const res = await fetch('/predict', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(payload)
            });

            if (!res.ok) {
                const err = await res.json();
                alert("Error: " + (err.detail || "Request failed"));
                throw new Error(err.detail);
            }

            const data = await res.json();
            showResult(data);
            // Assuming backend logs request and we use timestamp as ID or we need to get ID back?
            // User spec said: "Provide POST /feedback endpoint ... with original request id". 
            // My backend currently doesn't return request_id in response. 
            // I'll assume request_id is not critical or generated on client side logic? 
            // Or I should update backend to return ID. 
            // For now, I'll generate a dummy ID or use timestamp.
            currentRequestId = "req_" + Date.now(); 

        } catch (err) {
            console.error(err);
        } finally {
            btn.disabled = false;
            btn.innerText = "Predict Status";
        }
    });

    function showResult(data) {
        document.getElementById('resultCard').style.display = 'block';
        
        const badge = document.getElementById('resBadge');
        badge.innerText = data.label;
        badge.className = 'badge ' + data.label;

        document.getElementById('resScore').innerText = data.score;
        document.getElementById('resPercentile').innerText = data.percentile;
        
        // Advice logic if not in backend 'notes'
        let feedbackText = data.notes;
        if (data.label === 'Normal') feedbackText += " — Model sees this as typical traffic.";
        else feedbackText += " — Unusual pattern detected.";
        document.getElementById('resNotes').innerText = feedbackText;

        const featList = document.getElementById('resFeatures');
        featList.innerHTML = '';
        if (data.top_features) {
            data.top_features.forEach(ft => {
                const li = document.createElement('li');
                li.innerText = `${ft.feature}: ${ft.value} (${ft.explanation})`;
                featList.appendChild(li);
            });
        }
    }

    async function sendFeedback(type) {
        const actual = (type === 'correct') ? document.getElementById('resBadge').innerText : 'Unknown';
        
        try {
            await fetch('/feedback', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    request_id: currentRequestId,
                    feedback_label: type,
                    actual_label: actual
                }) // matches FeedbackRequest in main.py
            });
            alert("Feedback sent!");
            document.getElementById('feedbackSection').style.display = 'none';
        } catch (err) {
            alert("Failed to send feedback");
        }
    }
</script>

</body>
</html>
